@{
    ViewData["Title"] = "Sales Report";
}

<h2>Sales by Product & Region</h2>

<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-auto">
                <label class="form-label">Start Date</label>
                <input type="date" id="startDate" class="form-control" value="2024-01-01">
            </div>
            <div class="col-auto">
                <label class="form-label">End Date</label>
                <input type="date" id="endDate" class="form-control" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")">
            </div>
            <div class="col-auto d-flex align-items-end">
                <button type="button" class="btn btn-primary" onclick="loadReport()">Load Report</button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <canvas id="salesChart"></canvas>
    </div>
    <div class="col-md-6">
        <table class="table table-striped" id="salesTable">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Region</th>
                    <th>Qty Sold</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function loadReport() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        const response = await fetch(`/api/reports/sales?start=${start}&end=${end}`);
        const data = await response.json();

        // Fill Table
        const tbody = document.querySelector('#salesTable tbody');
        tbody.innerHTML = '';
        data.forEach(row => {
            tbody.innerHTML += `<tr>
                <td>${row.month}</td>
                <td>${row.productName}</td>
                <td>${row.category}</td>
                <td>${row.region}</td>
                <td>${row.totalQuantity}</td>
            </tr>`;
        });

        // Chart
        // Aggregate by Region for simple chart
        const regionData = {};
        data.forEach(r => {
            regionData[r.region] = (regionData[r.region] || 0) + r.totalQuantity;
        });

        const ctx = document.getElementById('salesChart');
        // Destroy existing if needed (skipped for brevity)
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(regionData),
                datasets: [{
                    label: 'Sales by Region',
                    data: Object.values(regionData),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            }
        });
    }

    // Load default
    loadReport();
</script>

