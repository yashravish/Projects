generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  collections  Collection[]
  queryLogs    QueryLog[]
}

model Collection {
  id          String     @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   Document[]
  queryLogs   QueryLog[]

  @@index([userId])
}

model Document {
  id            String          @id @default(cuid())
  collectionId  String
  userId        String
  filename      String
  originalName  String
  mimeType      String
  sizeBytes     Int
  status        DocumentStatus  @default(PENDING)
  errorMessage  String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  collection    Collection      @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  chunks        DocumentChunk[]

  @@index([collectionId])
  @@index([userId])
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model DocumentChunk {
  id          String                     @id @default(cuid())
  documentId  String
  userId      String
  chunkIndex  Int
  content     String
  tokenCount  Int
  embedding   Unsupported("vector(1536)")?
  createdAt   DateTime                   @default(now())

  document    Document                   @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([userId])
}

model QueryLog {
  id               String     @id @default(cuid())
  userId           String
  collectionId     String
  question         String
  answer           String
  citationChunks   String[]
  keyFacts         Json?
  summary          String?
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  latencyMs        Int
  createdAt        DateTime   @default(now())

  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  collection       Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([collectionId])
  @@index([createdAt])
}
